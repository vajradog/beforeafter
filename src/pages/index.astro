---
import '../styles/global.css';

const base = import.meta.env.BASE_URL;
---

<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
    <meta name="description" content="Take perfectly aligned before & after photos with onion skin overlay. Free, private, no sign-up." />
    <meta name="theme-color" content="#0066FF" />
    <link rel="icon" type="image/svg+xml" href={`${base}favicon.svg`} />
    <link rel="manifest" href={`${base}manifest.json`} />
    <link rel="apple-touch-icon" href={`${base}icon-192.svg`} />
    <title>Before/After Pro</title>
  </head>

  <body class="bg-[#111827] text-white overflow-hidden h-full select-none">

    <!-- ========== LANDING SCREEN ========== -->
    <div id="screen-landing" class="fixed inset-0 flex flex-col items-center justify-center bg-[#111827] z-50 p-6 text-center">
      <div class="max-w-md w-full space-y-8">
        <div>
          <div class="text-5xl mb-4">üì∏</div>
          <h1 class="text-3xl font-bold tracking-tight">Before/After Pro</h1>
          <p class="text-gray-400 mt-3 text-lg">Take perfectly aligned before &amp; after photos</p>
        </div>

        <div class="space-y-3 text-left text-sm text-gray-400">
          <div class="flex items-start gap-3 bg-white/5 rounded-xl p-4">
            <span class="text-xl mt-0.5">üéØ</span>
            <div>
              <div class="text-white font-semibold">Onion skin overlay</div>
              <div>See your before photo while taking the after ‚Äî line up shots perfectly</div>
            </div>
          </div>
          <div class="flex items-start gap-3 bg-white/5 rounded-xl p-4">
            <span class="text-xl mt-0.5">üì§</span>
            <div>
              <div class="text-white font-semibold">Instant exports</div>
              <div>Side-by-side image or interactive slider ‚Äî download to your device</div>
            </div>
          </div>
          <div class="flex items-start gap-3 bg-white/5 rounded-xl p-4">
            <span class="text-xl mt-0.5">üîí</span>
            <div>
              <div class="text-white font-semibold">100% private</div>
              <div>Photos never leave your device. No uploads, no accounts.</div>
            </div>
          </div>
        </div>

        <button
          id="btn-start"
          class="w-full bg-[#0066FF] hover:bg-[#0052cc] text-white text-xl font-bold py-5 px-8 rounded-2xl transition-colors active:scale-[0.97] transform"
        >
          Start Taking Photos
        </button>

        <p class="text-xs text-gray-600">Free forever. Made for hardworking people.</p>
      </div>
    </div>

    <!-- ========== SCREEN 1: TAKE BEFORE PHOTO ========== -->
    <div id="screen-before" class="fixed inset-0 bg-black hidden">
      <!-- Camera viewfinder (full screen) -->
      <video id="video-before" class="absolute inset-0 w-full h-full object-cover" autoplay playsinline muted></video>

      <!-- Camera unavailable fallback -->
      <div id="no-camera-before" class="absolute inset-0 flex flex-col items-center justify-center bg-gray-900 hidden z-10">
        <div class="text-5xl mb-4">üì∑</div>
        <p class="text-gray-400 text-lg mb-4">Camera not available</p>
        <label class="bg-[#0066FF] hover:bg-[#0052cc] text-white font-bold py-4 px-8 rounded-2xl cursor-pointer text-lg transition-colors">
          Upload Before Photo
          <input type="file" id="file-before" accept="image/*" capture="environment" class="hidden" />
        </label>
      </div>

      <!-- Top status bar (overlay) -->
      <div class="absolute top-0 left-0 right-0 p-4 flex items-center justify-between bg-gradient-to-b from-black/60 to-transparent z-20">
        <span class="bg-white/20 text-white text-sm font-bold px-4 py-2 rounded-full backdrop-blur-sm">STEP 1 of 2</span>
      </div>

      <!-- Bottom controls (overlay on viewfinder) -->
      <div class="absolute bottom-0 left-0 right-0 px-4 py-4 pb-6 flex flex-col items-center gap-2 bg-gradient-to-t from-black/70 to-transparent z-20">
        <button
          id="btn-capture-before"
          class="w-full max-w-sm bg-[#0066FF] hover:bg-[#0052cc] text-white text-lg font-bold py-4 rounded-2xl transition-colors active:scale-[0.97] transform shadow-lg"
        >
          Take Before Photo
        </button>
        <label class="text-gray-300 text-xs cursor-pointer hover:text-white transition-colors">
          or upload from gallery
          <input type="file" id="file-before-alt" accept="image/*" class="hidden" />
        </label>
      </div>
    </div>

    <!-- ========== SCREEN 2: TAKE AFTER PHOTO (ONION SKIN) ========== -->
    <div id="screen-after" class="fixed inset-0 bg-black hidden">
      <!-- Camera viewfinder (full screen) -->
      <video id="video-after" class="absolute inset-0 w-full h-full object-cover" autoplay playsinline muted></video>

      <!-- Onion skin overlay (before photo) -->
      <img
        id="onion-skin"
        class="absolute inset-0 w-full h-full object-cover pointer-events-none"
        alt=""
        style="opacity: 0.4;"
      />

      <!-- Camera unavailable fallback -->
      <div id="no-camera-after" class="absolute inset-0 flex flex-col items-center justify-center bg-gray-900 hidden z-10">
        <div class="text-5xl mb-4">üì∑</div>
        <p class="text-gray-400 text-lg mb-4">Camera not available</p>
        <label class="bg-[#0066FF] hover:bg-[#0052cc] text-white font-bold py-4 px-8 rounded-2xl cursor-pointer text-lg transition-colors">
          Upload After Photo
          <input type="file" id="file-after" accept="image/*" capture="environment" class="hidden" />
        </label>
      </div>

      <!-- Top status bar (overlay) -->
      <div class="absolute top-0 left-0 right-0 p-4 flex items-center justify-between bg-gradient-to-b from-black/60 to-transparent z-20">
        <span class="bg-white/20 text-white text-sm font-bold px-4 py-2 rounded-full backdrop-blur-sm">STEP 2 of 2</span>
        <button
          id="btn-retake-before"
          class="bg-white/20 text-white text-sm font-semibold px-4 py-2 rounded-full backdrop-blur-sm hover:bg-white/30 transition-colors"
        >
          ‚Üê Retake Before
        </button>
      </div>

      <!-- Bottom controls: opacity slider + capture button (overlay on viewfinder) -->
      <div class="absolute bottom-0 left-0 right-0 px-4 py-3 pb-5 flex flex-col items-center gap-2 bg-gradient-to-t from-black/80 via-black/50 to-transparent z-20">
        <!-- Opacity slider -->
        <div class="w-full max-w-sm">
          <div class="flex items-center justify-between text-xs text-gray-300 mb-1">
            <span>Live view</span>
            <span id="opacity-label" class="font-mono text-white">40%</span>
            <span>Before overlay</span>
          </div>
          <input
            type="range"
            id="opacity-slider"
            class="opacity-slider w-full"
            min="0"
            max="100"
            value="40"
          />
        </div>

        <button
          id="btn-capture-after"
          class="w-full max-w-sm bg-[#0066FF] hover:bg-[#0052cc] text-white text-lg font-bold py-4 rounded-2xl transition-colors active:scale-[0.97] transform shadow-lg"
        >
          Take After Photo
        </button>
        <label class="text-gray-300 text-xs cursor-pointer hover:text-white transition-colors">
          or upload from gallery
          <input type="file" id="file-after-alt" accept="image/*" class="hidden" />
        </label>
      </div>
    </div>

    <!-- ========== SCREEN 3: EXPORT ========== -->
    <div id="screen-export" class="fixed inset-0 flex flex-col bg-[#111827] overflow-y-auto hidden">
      <div class="max-w-lg mx-auto w-full p-4 pt-6 pb-10 space-y-5">

        <!-- Interactive slider preview (THE MAIN EVENT) -->
        <div>
          <p class="text-xs text-gray-500 text-center mb-2 font-semibold uppercase tracking-wide">Drag to compare</p>
          <div id="inline-slider" class="relative w-full rounded-2xl overflow-hidden bg-black select-none" style="line-height:0; max-height:55vh;">
            <img class="slider-after-img block w-full h-auto" alt="After" draggable="false" />
            <div class="slider-overlay absolute top-0 left-0 w-1/2 h-full overflow-hidden">
              <img class="slider-before-img absolute top-0 left-0 block h-full" alt="Before" draggable="false" style="max-width:none;" />
            </div>
            <div class="slider-handle absolute top-0 bottom-0 left-1/2 w-1 -ml-0.5 bg-white cursor-ew-resize z-10" style="box-shadow:0 0 8px rgba(0,0,0,0.5);">
              <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-10 h-10 bg-white rounded-full shadow-lg flex items-center justify-center">
                <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M8 9l-3 3 3 3M16 9l3 3-3 3" />
                </svg>
              </div>
            </div>
            <div class="absolute top-3 left-3 px-3 py-1.5 bg-black/60 text-white text-xs font-bold rounded-md uppercase tracking-wide backdrop-blur-sm">Before</div>
            <div class="absolute top-3 right-3 px-3 py-1.5 bg-black/60 text-white text-xs font-bold rounded-md uppercase tracking-wide backdrop-blur-sm">After</div>
          </div>
        </div>

        <!-- Save individual photos -->
        <div>
          <h3 class="text-xs text-gray-500 font-semibold uppercase tracking-wide mb-2">Save Photos</h3>
          <div class="grid grid-cols-2 gap-3">
            <!-- Save Before -->
            <button
              id="btn-save-before"
              class="flex flex-col items-center gap-2 bg-white/5 hover:bg-white/10 active:bg-white/15 rounded-2xl p-4 transition-colors group"
            >
              <div class="w-full aspect-[4/3] rounded-xl overflow-hidden bg-black/30">
                <img id="preview-before" class="w-full h-full object-cover" alt="Before photo" />
              </div>
              <div class="flex items-center gap-2 text-sm font-semibold text-gray-300 group-hover:text-white transition-colors">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                </svg>
                Save Before
              </div>
            </button>

            <!-- Save After -->
            <button
              id="btn-save-after"
              class="flex flex-col items-center gap-2 bg-white/5 hover:bg-white/10 active:bg-white/15 rounded-2xl p-4 transition-colors group"
            >
              <div class="w-full aspect-[4/3] rounded-xl overflow-hidden bg-black/30">
                <img id="preview-after" class="w-full h-full object-cover" alt="After photo" />
              </div>
              <div class="flex items-center gap-2 text-sm font-semibold text-gray-300 group-hover:text-white transition-colors">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                </svg>
                Save After
              </div>
            </button>
          </div>
        </div>

        <!-- Combined export -->
        <div>
          <h3 class="text-xs text-gray-500 font-semibold uppercase tracking-wide mb-2">Share Comparison</h3>
          <div class="space-y-2">
            <!-- Side-by-side -->
            <button
              id="btn-export-sidebyside"
              class="w-full flex items-center gap-4 bg-[#0066FF]/10 hover:bg-[#0066FF]/20 active:bg-[#0066FF]/30 border border-[#0066FF]/30 rounded-2xl p-4 transition-colors text-left group"
            >
              <div class="w-11 h-11 bg-[#0066FF]/20 rounded-xl flex items-center justify-center shrink-0">
                <svg class="w-6 h-6 text-[#0066FF]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
              </div>
              <div class="flex-1 min-w-0">
                <div class="font-bold text-white text-sm">Side-by-Side Image</div>
                <div class="text-xs text-gray-400">One image, both photos ‚Äî great for texting</div>
              </div>
              <svg class="w-5 h-5 text-[#0066FF]/60 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
              </svg>
            </button>

            <!-- HTML Slider (for website/embed) -->
            <button
              id="btn-export-slider"
              class="w-full flex items-center gap-4 bg-white/5 hover:bg-white/10 active:bg-white/15 rounded-2xl p-4 transition-colors text-left group"
            >
              <div class="w-11 h-11 bg-white/10 rounded-xl flex items-center justify-center shrink-0">
                <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4" />
                </svg>
              </div>
              <div class="flex-1 min-w-0">
                <div class="font-semibold text-gray-300 text-sm">Slider for Website</div>
                <div class="text-xs text-gray-500">HTML file ‚Äî embed on your site</div>
              </div>
              <svg class="w-5 h-5 text-gray-600 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
              </svg>
            </button>
          </div>
        </div>

        <!-- Status message -->
        <div id="export-status" class="text-center text-sm text-green-400 hidden">
          Saved! Check your photos or downloads.
        </div>

        <!-- Start over -->
        <button
          id="btn-start-over"
          class="w-full bg-white/5 hover:bg-white/10 text-gray-400 hover:text-white font-semibold py-4 rounded-2xl transition-colors"
        >
          Start Over
        </button>
      </div>
    </div>

    <script>
      import { startCamera, stopCamera, captureFrame, hasCameraSupport } from '../utils/camera';
      import { resizeImage } from '../utils/imageProcessing';
      import { exportSideBySide, exportSingleImage, exportHtmlSlider, initInlineSlider } from '../utils/exporters';

      // ---- State ----
      let beforeDataUrl: string | null = null;
      let afterDataUrl: string | null = null;
      let currentStream: MediaStream | null = null;

      // ---- DOM refs ----
      const screenLanding = document.getElementById('screen-landing')!;
      const screenBefore = document.getElementById('screen-before')!;
      const screenAfter = document.getElementById('screen-after')!;
      const screenExport = document.getElementById('screen-export')!;

      const videoBefore = document.getElementById('video-before') as HTMLVideoElement;
      const videoAfter = document.getElementById('video-after') as HTMLVideoElement;
      const noCameraBefore = document.getElementById('no-camera-before')!;
      const noCameraAfter = document.getElementById('no-camera-after')!;

      const onionSkin = document.getElementById('onion-skin') as HTMLImageElement;
      const opacitySlider = document.getElementById('opacity-slider') as HTMLInputElement;
      const opacityLabel = document.getElementById('opacity-label')!;

      const previewBefore = document.getElementById('preview-before') as HTMLImageElement;
      const previewAfter = document.getElementById('preview-after') as HTMLImageElement;
      const exportStatus = document.getElementById('export-status')!;
      const inlineSlider = document.getElementById('inline-slider')!;

      // ---- Screen management ----
      function showScreen(screen: HTMLElement) {
        [screenLanding, screenBefore, screenAfter, screenExport].forEach((s) =>
          s.classList.add('hidden')
        );
        screen.classList.remove('hidden');
      }

      // ---- Camera helpers ----
      async function openCamera(videoEl: HTMLVideoElement, fallbackEl: HTMLElement) {
        if (!hasCameraSupport()) {
          fallbackEl.classList.remove('hidden');
          return;
        }

        try {
          currentStream = await startCamera(videoEl, { facingMode: 'environment' });
        } catch (err) {
          console.warn('Camera access failed:', err);
          fallbackEl.classList.remove('hidden');
        }
      }

      function closeCamera() {
        stopCamera(currentStream);
        currentStream = null;
        videoBefore.srcObject = null;
        videoAfter.srcObject = null;
      }

      // ---- File upload helper ----
      function handleFileUpload(input: HTMLInputElement): Promise<string> {
        return new Promise((resolve, reject) => {
          const file = input.files?.[0];
          if (!file) return reject(new Error('No file selected'));

          const reader = new FileReader();
          reader.onload = () => resolve(reader.result as string);
          reader.onerror = () => reject(reader.error);
          reader.readAsDataURL(file);
        });
      }

      // ---- Landing screen ----
      document.getElementById('btn-start')!.addEventListener('click', async () => {
        showScreen(screenBefore);
        await openCamera(videoBefore, noCameraBefore);
      });

      // ---- Screen 1: Take Before Photo ----
      document.getElementById('btn-capture-before')!.addEventListener('click', async () => {
        if (!videoBefore.srcObject) return;
        const raw = captureFrame(videoBefore);
        beforeDataUrl = await resizeImage(raw, 1920);
        closeCamera();
        goToAfterScreen();
      });

      // File upload for before (both inputs)
      ['file-before', 'file-before-alt'].forEach((id) => {
        document.getElementById(id)!.addEventListener('change', async (e) => {
          try {
            const raw = await handleFileUpload(e.target as HTMLInputElement);
            beforeDataUrl = await resizeImage(raw, 1920);
            closeCamera();
            goToAfterScreen();
          } catch { /* user cancelled */ }
        });
      });

      async function goToAfterScreen() {
        showScreen(screenAfter);
        // Set onion skin image
        if (beforeDataUrl) {
          onionSkin.src = beforeDataUrl;
          onionSkin.classList.remove('hidden');
        }
        await openCamera(videoAfter, noCameraAfter);
      }

      // ---- Screen 2: Take After Photo (Onion Skin) ----

      // Opacity slider
      opacitySlider.addEventListener('input', () => {
        const val = parseInt(opacitySlider.value);
        onionSkin.style.opacity = (val / 100).toString();
        opacityLabel.textContent = `${val}%`;
      });

      document.getElementById('btn-capture-after')!.addEventListener('click', async () => {
        if (!videoAfter.srcObject) return;
        const raw = captureFrame(videoAfter);
        afterDataUrl = await resizeImage(raw, 1920);
        closeCamera();
        goToExportScreen();
      });

      // File upload for after (both inputs)
      ['file-after', 'file-after-alt'].forEach((id) => {
        document.getElementById(id)!.addEventListener('change', async (e) => {
          try {
            const raw = await handleFileUpload(e.target as HTMLInputElement);
            afterDataUrl = await resizeImage(raw, 1920);
            closeCamera();
            goToExportScreen();
          } catch { /* user cancelled */ }
        });
      });

      // Retake before
      document.getElementById('btn-retake-before')!.addEventListener('click', async () => {
        beforeDataUrl = null;
        closeCamera();
        showScreen(screenBefore);
        await openCamera(videoBefore, noCameraBefore);
      });

      function goToExportScreen() {
        showScreen(screenExport);
        if (beforeDataUrl) previewBefore.src = beforeDataUrl;
        if (afterDataUrl) previewAfter.src = afterDataUrl;
        exportStatus.classList.add('hidden');

        // Initialize the inline interactive slider
        if (beforeDataUrl && afterDataUrl) {
          initInlineSlider(inlineSlider, beforeDataUrl, afterDataUrl);
        }
      }

      // ---- Screen 3: Export ----

      // Helper: disable button during async action
      async function withButton(btnId: string, action: () => Promise<void>) {
        const btn = document.getElementById(btnId)!;
        btn.classList.add('opacity-50', 'pointer-events-none');
        try {
          await action();
          flashStatus();
        } finally {
          btn.classList.remove('opacity-50', 'pointer-events-none');
        }
      }

      // Save individual before photo
      document.getElementById('btn-save-before')!.addEventListener('click', () => {
        if (!beforeDataUrl) return;
        withButton('btn-save-before', () => exportSingleImage(beforeDataUrl!, 'before.jpg'));
      });

      // Save individual after photo
      document.getElementById('btn-save-after')!.addEventListener('click', () => {
        if (!afterDataUrl) return;
        withButton('btn-save-after', () => exportSingleImage(afterDataUrl!, 'after.jpg'));
      });

      // Side-by-side comparison
      document.getElementById('btn-export-sidebyside')!.addEventListener('click', () => {
        if (!beforeDataUrl || !afterDataUrl) return;
        withButton('btn-export-sidebyside', () => exportSideBySide(beforeDataUrl!, afterDataUrl!));
      });

      // HTML slider file (for website embed)
      document.getElementById('btn-export-slider')!.addEventListener('click', () => {
        if (!beforeDataUrl || !afterDataUrl) return;
        withButton('btn-export-slider', () => exportHtmlSlider(beforeDataUrl!, afterDataUrl!));
      });

      function flashStatus() {
        exportStatus.classList.remove('hidden');
        setTimeout(() => exportStatus.classList.add('hidden'), 4000);
      }

      // Start over
      document.getElementById('btn-start-over')!.addEventListener('click', () => {
        beforeDataUrl = null;
        afterDataUrl = null;
        closeCamera();
        previewBefore.src = '';
        previewAfter.src = '';
        // Reset file inputs
        document.querySelectorAll<HTMLInputElement>('input[type="file"]').forEach((i) => (i.value = ''));
        showScreen(screenLanding);
      });

      // ---- PWA: Register service worker ----
      if ('serviceWorker' in navigator) {
        const base = document.querySelector<HTMLLinkElement>('link[rel="manifest"]')?.href.replace('manifest.json', '') || '/';
        navigator.serviceWorker.register(`${base}sw.js`).catch(() => {});
      }
    </script>
  </body>
</html>
